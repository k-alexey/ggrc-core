#!/usr/bin/env bash
# Copyright (C) 2019 Google Inc.
# Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>

SCRIPTPATH=$( cd "$(dirname "$0")" ; pwd -P )
cd "${SCRIPTPATH}/../test"

source "${SCRIPTPATH}/init_test_env"

PROCESSES=8

find ./integration/ -name "test_*.py" > testfiles
for ((i=1;i<=PROCESSES;i++))
do
GGRC_TEST_DB="ggrcdevtest_$i" db_reset -d "ggrcdevtest_$i"
done

echo -e "\nRunning integration tests"
for ((i=1;i<=PROCESSES;i++))
do
$(split -n l/$i/$PROCESSES testfiles | tr '\n' ' ' | GGRC_TEST_DB="ggrcdevtest_$i" xargs nosetests)&
done
rm testfiles
wait